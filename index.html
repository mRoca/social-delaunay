<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="Author" content="Michel Roca">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Delaunay</title>
</head>
<body>

<canvas id="canvas" height="480" width="600" style="border: 1px solid #aaa;"></canvas>
<canvas id="canvas-target" height="480" width="600" style="border: 1px solid #aaa;"></canvas>

<p>Drop an image onto the canvas to change it.</p>

<input type="number" id="count" value="50">

<button id="go">Go</button>
<button id="test">TEST</button>
<button id="save">Save image</button>

<pre id="data"></pre>

<script src="vendor/delaunay-fast/delaunay.js"></script>
<script src="helpers.js"></script>
<script src="social-data.js"></script>
<script src="delaunay-image.js"></script>
<script>
    (function() {
        var
                canvas = document.getElementById("canvas"),
                canvasTarget = document.getElementById("canvas-target"),
                saveButton = document.getElementById("save"),
                goButton = document.getElementById("go"),
                dotsCountInput = document.getElementById("count"),
                dataPre = document.getElementById("data"),
                context = canvas.getContext("2d"),
                img = document.createElement("img"),
                data,
                socialData
                ;

        // Default image
        img.src = 'example.jpg';

        // Image loading
        img.addEventListener("load", function() {
            context.drawImage(img, 0, 0, canvas.width, canvas.height);
            goButton.click();
        }, false);

        // To enable drag and drop
        canvas.addEventListener("dragover", function(evt) {
            evt.preventDefault();
        }, false);

        // Handle dropped image file - only Firefox and Google Chrome
        canvas.addEventListener("drop", function(evt) {

            var files = evt.dataTransfer.files;
            if (files.length > 0) {
                var file = files[0];
                if (typeof FileReader !== "undefined" && file.type.indexOf("image") != -1) {
                    var reader = new FileReader();
                    // Note: addEventListener doesn't work in Google Chrome for this event
                    reader.onload = function(evt) {
                        img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            evt.preventDefault();
        }, false);

        // Save image
        saveButton.addEventListener("click", function(e) {
            e.preventDefault();
            window.open(canvasTarget.toDataURL("image/png"));
        }, false);

        // Go
        goButton.addEventListener("click", function(e) {
            data = DelaunayImage.getData(img, {canvas: canvasTarget, count: dotsCountInput.value});
            DelaunayImage.process(data);
        }, false);

        document.getElementById("test").addEventListener("click", function(e) {
            if (!data) {
                return;
            }

//            socialData = SocialData.generateFakeData();
//            dataPre.innerHTML = JSON.stringify(socialData, null, 4);

            var chosenTriangleId = random(data.triangles.length);
            var chosenTriangle = data.triangles[chosenTriangleId];
            var chosenCenter = triangleCentroid(chosenTriangle);
            var chosenTriangleRate = random(30);

            function directionFactor(coor, centerCoor) {
                return coor > centerCoor ? -1 : 1;
            }

            function rateByDistance(distance, maxDistance, rate) {
                return -1 * Math.pow(distance / maxDistance, 2) * rate;
            }

            function awayDotFromCenter(dot, center, width, height, rate) {
                return [
                    dot[0] + directionFactor(dot[0], center[0]) * rateByDistance(center[0] - dot[0], width, rate),
                    dot[1] + directionFactor(dot[1], center[1]) * rateByDistance(center[1] - dot[1], height, rate)
                ];
            }

            for (var i = 0; i < data.triangles.length; i++) {
                for (var j = 0; j < data.triangles[i].length; j++) {

                    data.triangles[i][j] = awayDotFromCenter(
                            data.triangles[i][j],
                            chosenCenter,
                            data.canvas.width,
                            data.canvas.height,
                            chosenTriangleRate
                    );
                }
            }

            DelaunayImage.process(data);
        }, false);

    })();
</script>
</body>
</html>
