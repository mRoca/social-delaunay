<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="Author" content="Michel Roca">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Delaunay</title>
</head>
<body>

<canvas id="canvas" height="400" width="600" style="border: 1px solid #aaa;"></canvas>
<canvas id="canvas-target" height="400" width="600" style="border: 1px solid #aaa;"></canvas>

<input type="number" id="count" value="50">

<button id="go" style="display: none;">Go</button>
<button id="save" style="display: none;">Save image</button>

<script src="vendor/delaunay-fast/delaunay.js"></script>
<script src="delaunay-image.js"></script>
<script>
    (function() {
        var
                canvas = document.getElementById("canvas"),
                canvasTarget = document.getElementById("canvas-target"),
                saveButton = document.getElementById("save"),
                goButton = document.getElementById("go"),
                context = canvas.getContext("2d"),
                img = document.createElement("img"),
                hasText = true,
                clearCanvas = function() {
                    if (hasText) {
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        hasText = false;
                    }
                };

        // Adding instructions
        context.fillText("Drop an image onto the canvas", 240, 200);

        // Image for loading
        img.addEventListener("load", function() {
            clearCanvas();
            context.drawImage(img, 0, 0, canvas.width, canvas.height);
        }, false);

        // To enable drag and drop
        canvas.addEventListener("dragover", function(evt) {
            evt.preventDefault();
        }, false);

        // Handle dropped image file - only Firefox and Google Chrome
        canvas.addEventListener("drop", function(evt) {

            var files = evt.dataTransfer.files;
            if (files.length > 0) {
                var file = files[0];
                if (typeof FileReader !== "undefined" && file.type.indexOf("image") != -1) {
                    var reader = new FileReader();
                    // Note: addEventListener doesn't work in Google Chrome for this event
                    reader.onload = function(evt) {
                        img.src = evt.target.result;
                        goButton.style.display = 'inline-block';
                    };
                    reader.readAsDataURL(file);
                }
            }
            evt.preventDefault();
        }, false);

        // Save image
        saveButton.addEventListener("click", function(e) {
            e.preventDefault();
            window.open(canvasTarget.toDataURL("image/png"));
        }, false);

        // Go
        goButton.addEventListener("click", function(e) {
            var opt = { canvas: canvasTarget, count: document.getElementById("count").value };
            var result = DelaunayImage.process(img, opt);
            if(result) {
                saveButton.style.display = 'inline-block';
            }
            console.log(opt, result);
        }, false);

    })();
</script>
</body>
</html>
